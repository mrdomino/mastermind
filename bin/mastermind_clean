#!/usr/bin/env shoes

$: << File.join(File.dirname(__FILE__), %w(.. lib))

require 'mastermind'

module Mastermind::GUIConstants
  PEG_DIA = 40
  PEG_PAD = 5
  PEG_SIZE = PEG_DIA + (PEG_PAD*2)
  ELEM_PAD = 8
  CPAN_WIDTH = PEG_SIZE + (ELEM_PAD*2)

  GUESS_HEIGHT = PEG_SIZE+ELEM_PAD

  def self.GUESS_WIDTH(pegs)
    PEG_SIZE*pegs
  end

  def self.HINT_WIDTH(pegs)
    PEG_SIZE/4*(pegs+1)
  end

  def self.APP_HEIGHT(guesses,colors)
    [colors*PEG_SIZE, (guesses+1)*GUESS_HEIGHT].max
  end

  def self.APP_WIDTH(pegs)
    CPAN_WIDTH + GUESS_WIDTH(pegs) + HINT_WIDTH(pegs) + ELEM_PAD
  end
end

class MastermindGUI < Shoes
  url '/', :index
  url '/game/(\d+)/(\d+)/(\d+)', :game

  def index
    background white
    stack do
      title "Mastermind", :underline => 'single'
      para sub("by ", em("Steven Dee")), :align => "right"

      para 'Begin a new game:'
      [[:easy , [6,4,10]],
       [:medium , [8,5,12]],
       [:difficult , [10,6,14]]].each do |d,p|
        para link(d.to_s.capitalize, :click => "/game/#{p.join("/")}"), :align => 'center'
      end
    end
  end

  def game(colors,pegs,guesses)
    colors,pegs,guesses = [colors,pegs,guesses].map &:to_i
    window :title => "Mastermind :: Game [#{colors},#{pegs},#{guesses}]",
           :height => Mastermind::GUIConstants.APP_HEIGHT(guesses,colors),
           :width =>  Mastermind::GUIConstants.APP_WIDTH(pegs) do
      background rgb(225,225,225)..white

      @colors = Mastermind::Colors.colors(colors)
      @active = -1

      # Overall rendering.
      def render
        do_color_panel
        do_game_board
      end

      def peg(c,args = {})
        image(Mastermind::GUIConstants::PEG_SIZE,
              Mastermind::GUIConstants::PEG_SIZE) do
          if args[:active] then
            fill black
            nostroke
            rect :width => Mastermind::GUIConstants::PEG_SIZE,
                 :height => Mastermind::GUIConstants::PEG_SIZE,
                 :curve => Mastermind::GUIConstants::PEG_PAD
          end
          fill c;
          oval :radius => Mastermind::GUIConstants::PEG_DIA/2,
               :top => Mastermind::GUIConstants::PEG_PAD,
               :left => Mastermind::GUIConstants::PEG_PAD
        end
      end

      def do_color_panel
        @color_panel.clear do
          @colors.each_with_index do |c,i|
            x = peg c, :active => i == @active
            x.click do
              @active = i
              do_color_panel
            end
          end
        end
      end

      def do_game_board
        @game_board.clear do
          para "bye"
        end
      end

      # Main layout.
      flow do
        @color_panel = stack :width => Mastermind::GUIConstants::CPAN_WIDTH,
                             :margin => Mastermind::GUIConstants::ELEM_PAD
        @game_board = stack :width => -Mastermind::GUIConstants::CPAN_WIDTH

        render
      end
    end
    visit "/"
  end

end

Shoes.app :title => "Mastermind", :width => 250, :height => 275
